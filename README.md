**任务二描述：**

**基于ZigBee模块（白板）和红外传感模块（白板）模拟实现传送带运转情况的检测系统，运用中断、定时器功能实现传送带行进方向和速度的检测，并将相关信息发送到串口助手。（注意：**把ZigBee模块和红外传感模块放在实验平台上，考生可用配套挡片对两个红外对射传感器依次遮挡来模拟传送带运行，如果是使用两个智慧盒请注意两个ZigBee白板的GND要接共地线**）**

**设备列表：**

1、PC机1台

2、ZigBee模块(白板) 1块

3、红外传感器模块（白板）1个（配挡片）

4、实验平台一套

5、CC Debugger仿真器1套

6、导线若干

7、串口线1根（或USB转串口线1根）

**接线图：**

![image](https://user-images.githubusercontent.com/104015167/172287182-8e5d9396-db94-42e7-a961-a07c4e78a007.png)


**接线说明：**

1.  ZigBee模块IN0（J13）接红外传感模块对射输出1（J5）
2.  ZigBee模块IN1（J12）接红外传感模块对射输出2（J6）

**任务要求：**

在工程源码目录“..\\work\\”下创建文件夹Task，在IAR中创建工程和工作区（均使用Task+准考证号后12位 命名）并保存到Task文件夹中，把Task文件夹中的test.c、hal_defs.h这2个文件添加到IAR工程中，配置工程选项参数，确保编译通过（4分）。其中：

1.  test.c中已完成串口的初始化设置，波特率115200，8位数据位，1位停止位，无校验位，无流控。
2.  test.c中已完成定时器T1的初始化配置：计数周期为1us、溢出周期为50ms，每次溢出中断会让counter公共变量自加1（该变量已定义，初值为0）。
3.  test.c中的SendMsg(参数)函数已实现将信息发送到串口。
4.  test.c中已定义flag_state公共变量（初值为0），其值含义为：

    0表示等待开始检测

    1表示已开始检测且传送带运行方向为正方向

    2表示已开始检测且传送带运行方向为反方向
    请在test.c中完善代码实现以下功能：

1、利用红外传感模块中的两个红外对射传感器来检测移动方向：

<tab>1）红外对射1先被遮挡表示正方向运行

2）红外对射2先被遮挡表示反方向运行

3）正常情况下红外对射传感器输出低电平，当有遮挡时输出高电平。

2、将ZigBee模块上IN0(P1.3)和IN1(P1.4)连接的单片机IO口设置为三态输入模式、下降沿触发中断。（12分）

3、利用红外传感模块中的两个红外对射传感器来检测速度： （20分）

1）当flag_state为0时，两个红外对射传感器中任何一个先被遮挡，都会导致检测开始，此时启动定时器T1开始工作（要求工作在模模式），并根据实际触发情况给flag_state赋值。

2）当flag_state不为0时，两个红外对射传感器中后被遮挡的那个将停止定时器T1的工作，完成一次检测。

3）每次检测完成后，可根据counter值、定时器T1计数寄存器的值、两个红外对射传感器直接距离（设定距离为5cm）计算传送带运行速度（要求计算结果为浮点数，单位m/s）。

4、计算完传送带运行速度后，调用SendMsg(参数)函数将信息发送到串口助手。（11分）

5、**考试时间截止后，应确保“图集.docx”和源码工程文件已保存妥当，将“work”文件夹压缩成“work.zip”文件，点击“上传文件”将压缩后的“work.zip”上传至服务器指定目录。**

